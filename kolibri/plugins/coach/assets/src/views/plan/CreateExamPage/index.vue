<template>

  <CoachImmersivePage
    :appBarTitle="$tr('createNewExamLabel')"
    :authorized="userIsAuthorized"
    authorizedRole="adminOrCoach"
    icon="close"
    :pageTitle="$tr('createNewExamLabel')"
    :route="backRoute"
  >

    <KPageContainer
      :style="{ ...maxContainerHeight, maxWidth: '1000px', margin: '0 auto' }"
    >

      <CreateQuizSection v-if="quizInitialized" />

      <BottomAppBar>
        <KButtonGroup>
          <KButton
            :text="coreString('saveAction')"
            primary
            @click="() => quizForge.saveQuiz()"
          />
        </KButtonGroup>
      </BottomAppBar>

    </KPageContainer>

  </CoachImmersivePage>

</template>


<script>

  import responsiveWindowMixin from 'kolibri.coreVue.mixins.responsiveWindowMixin';
  import { ref } from 'kolibri.lib.vueCompositionApi';
  import pickBy from 'lodash/pickBy';
  import BottomAppBar from 'kolibri.coreVue.components.BottomAppBar';
  import commonCoreStrings from 'kolibri.coreVue.mixins.commonCoreStrings';
  import { PageNames } from '../../../constants';
  import commonCoach from '../../common';
  import CoachImmersivePage from '../../CoachImmersivePage';
  import useQuizCreation from '../../../composables/useQuizCreation';
  import CreateQuizSection from './CreateQuizSection.vue';

  export default {
    name: 'CreateExamPage',
    components: {
      CoachImmersivePage,
      BottomAppBar,
      CreateQuizSection,
    },
    mixins: [commonCoreStrings, commonCoach, responsiveWindowMixin],
    setup() {
      const quizForge = useQuizCreation();
      const quizInitialized = ref(false);

      return {
        quizInitialized,
        quizForge,
      };
    },
    /**
     * @returns {object}
     * @property {object} quizForge - see useQuizCreation for details; this is a reflection of
     *                                the object returned by that function which is initialized
     *                                within this component
     * add `inject: ['quizForge']` to any descendant component to access this
     */
    provide() {
      return {
        quizForge: this.quizForge,
        showError: false,
        moreResultsState: null,
        // null corresponds to 'All' filter value
        filters: {
          channel: this.$route.query.channel || null,
          kind: this.$route.query.kind || null,
          role: this.$route.query.role || null,
        },
        // numQuestionsBlurred: false,
        bookmarksCount: 0,
        bookmarks: [],
        more: null,
        // showSectionSettingsMenu:false
      };
    },
    computed: {
      maxContainerHeight() {
        return { maxHeight: '1000px' };
      },
      backRoute() {
        return { name: PageNames.EXAMS };
      },
    },
    watch: {
      filters(newVal) {
        this.$router.push({
          query: { ...this.$route.query, ...pickBy(newVal) },
        });
      },
    },
    created() {
      this.quizForge.initializeQuiz();
      this.quizInitialized = true;
    },
    mounted() {
      this.$store.dispatch('notLoading');
    },
    $trs: {
      createNewExamLabel: {
        message: 'Create new quiz',
        context: "Title of the screen launched from the 'New quiz' button on the 'Plan' tab.",
      },
    },
  };

</script>


<style lang="scss" scoped></style>
